# Implementation Plan (September 25, 2025)

This plan breaks down the architecture refactor into granular, trackable tasks. After each numbered step, the assignee must:

- ensure the project builds cleanly without warnings,
- run all relevant automated tests (including any newly added or modified tests) and verify they pass,
- review the diff for unintended changes,
- create a descriptive git commit,
- push the branch to the origin remote to preserve the incremental history.

If any step cannot be completed as written, document the variance in this file before proceeding.

## ✅ 1. Introduce Application Composition Layer (Completed September 25, 2025)
1.1 ✅ Created the `UnifiedScanner/AppEnvironment` module defining protocols for shared services.
1.2 ✅ Implemented adapters wrapping the existing singleton-backed services.
1.3 ✅ Updated `UnifiedScannerApp` to build and inject an `AppEnvironment` via `environmentObject`.
1.4 ✅ Adjusted unit tests to inject dependencies through the new environment where needed.
1.5 ✅ Verified clean build/tests, committed, and pushed to `main`.

## ✅ 2. Decompose SnapshotService (Completed September 25, 2025)
2.1 ✅ Created `DevicePersistenceCoordinator` to handle load/save operations and detect snapshot differences.
2.2 ✅ Introduced `DeviceClassificationCoordinator` plus an injectable `SnapshotClock` to manage classification triggers and timing.
2.3 ✅ Added a `DeviceMutationPublishing` protocol with a `DeviceMutationBusPublisher` adapter so `SnapshotService` no longer depends on the global singleton directly.
2.4 ✅ Refactored `SnapshotService` to consume the new collaborators while preserving actor isolation and existing behaviors.
2.5 ✅ Updated related tests to inject the new publisher/coordinators and rely on the refactored service.
2.6 ✅ Verified clean builds/tests, committed, and pushed on `main`.

## ✅ 3. Replace Global Singletons With Injected Dependencies (Completed September 25, 2025)
3.1 ✅ Updated services (notably `HTTPFingerprintService`) to drop static hooks and rely on injected dependencies.
3.2 ✅ Adjusted `AppEnvironment` and `UnifiedScannerApp` to configure lookup providers and supply concrete implementations explicitly.
3.3 ✅ Audited remaining global references, introducing adapters for mutation publishing and OUI lookup injection.
3.4 ✅ Updated relevant tests to consume the injected publishers/services.
3.5 ✅ Verified builds/tests, committed, and pushed to `main`.

## ✅ 4. Modularize Classification and Display Name Rules (Completed September 25, 2025)
4.1 ✅ Split `ClassificationService` by introducing `ClassificationRulePipeline` with discrete rule types (`FingerprintClassificationRule`, `HostnamePatternClassificationRule`, `VendorHostnameClassificationRule`, `ServiceCombinationClassificationRule`, `PortProfileClassificationRule`, `FallbackClassificationRule`).
4.2 ✅ Added an injectable pipeline registry (`ClassificationRulePipelineRegistry`) so the rule set can be overridden per environment/tests while defaulting to the production stack.
4.3 ✅ Scoped Apple-specific heuristics into the fingerprint rule helpers and expanded the Apple model database entry set (e.g., added `MacBookPro16,1`) instead of hard-coded form-factor strings in the service.
4.4 ✅ Extended `DeviceClassificationTests` with rule-focused regression coverage to validate each strategy independently and to guarantee the authoritative fingerprint short-circuit behaviour.
4.5 ✅ Ran the full `UnifiedScanner` test suite with a clean build prior to committing and pushing.

## 5. Consolidate UI Status Components and Interaction Logic
5.1 ✅ Replaced duplicated status/progress UI with `StatusDashboardViewModel` + `StatusSectionView`, wiring `ContentView` to consume the shared model.
5.2 ✅ Introduced `DeviceDetailViewModel` to encapsulate port interactions (open/copy), updating `UnifiedDeviceDetail` to route actions through the model.
5.3 ✅ Added dedicated SwiftUI previews for `StatusSectionView` and `UnifiedDeviceDetail`, plus created launch sanity UI coverage using `UNIFIEDSCANNER_DISABLE_NETWORK_DISCOVERY` for deterministic runs.
5.4 ✅ Executed full macOS test suite (unit + UI), committed, and pushed to `main`.

## 6. Final Integration Pass
6.1 Perform a holistic audit ensuring all modules use injected dependencies, no residual singletons remain in production code paths, and documentation reflects the new architecture.
6.2 Update README/PROJECT_OVERVIEW with a high-level summary of the new architecture and dependency injection approach.
6.3 Run the full test suite, perform a final code review, commit, and push.

---

**Testing & Version Control Expectations**
- At every step above, execute relevant test targets (`UnifiedScannerTests`, UI tests where applicable) and add or update tests alongside code changes.
- Every successful step must end with a git commit and a push to origin, using descriptive messages (e.g. "Refactor SnapshotService to use DevicePersistenceCoordinator").
- If tests fail, resolve the issues before committing; document deviations in this plan.
- All work must occur directly on `main`; do not create topic branches.
